<!DOCTYPE html>
<html>
<head>
    <title>Active Permits Risk Screening Tool</title>

<style type="text/css">
html { 
	height: 100% 
}
body { 
	height: 100%; 
	margin: 0; 
	padding: 0;
	font-size: 12px;
	font-family: Arial, Helvetica, sans-serif;	
}
#map {
	position: absolute;
	height: 100%;
	width: 100%;
	background-color: #333;
	pointer-events: all;
}
div.tooltip {
	color: #222;
	background: #fff;
	padding: .5em;
	text-shadow: #f5f5f5 0 1px 0;
	border-radius: 7px; 
	box-shadow: 0px 0px 2px 0px #a6a6a6; 
	opacity: 0.9; 
	position: absolute;
	visibility: hidden;
}
.ui {
	top: 10px;
	left: 50px;
	padding: 8px;
	position: absolute;
	background-color: #fff;
	border: 2px solid #707070;
	border-radius: 7px;
	width: 280px;
}
.high {
	fill: #BF0000;
	fill-opacity: .7;
}
.medium {
	fill: #c6891f;
	fill-opacity: .7;
}
.low {
	fill: #BCB92F;
	fill-opacity: .5;
}
#vis{
}
<!-- .rings { -->
	<!-- fill: #d86666; -->
	<!-- fill-opacity: .35; -->
	
<!-- } -->
<!-- .other { -->
	<!-- fill: #e5e7ea; -->
	<!-- fill-opacity: .5;	 -->
<!-- } -->
</style>
    <link href='https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css'
    	rel='stylesheet' type='text/css'/>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">

</head>
<body>
	<div id="map">
		<div id="ui-container" class="ui" style="z-index: 401">		
			      <h4>Active Permits (As of <span id="today"></span>)</h4>
				  <h5>Risk Category</h5>
				  
				  <span style="display:inline-block; background-color:#BF0000; padding:0px; margin:0px; height:13px; width:13px; overflow:hidden"><input type="checkbox" style="opacity:0.50;padding:0px;margin:0px" name="risk" class="regular-checkbox" value="highRisk" id="highRisk" checked="true"/></span>
					<label for="highRisk"></label><span class="en">High Risk</span>
				  <br/>
				  
				  <span style="display:inline-block; background-color:#c6891f; padding:0px; margin:0px; height:13px; width:13px; overflow:hidden"><input type="checkbox" style="opacity:0.50;padding:0px;margin:0px" name="risk" class="regular-checkbox" value="medRisk" id="medRisk" /></span>
					<label for="medRisk"></label><span class="en">Medium Risk</span>
				  <br/>
				  
				  <!-- <span style="display:inline-block; background-color:#bcb92f; padding:0px; margin:0px; height:13px; width:13px; overflow:hidden"><input type="checkbox" style="opacity:0.50;padding:0px;margin:0px" name="risk" class="regular-checkbox" value="lowRisk" id="lowRisk" /></span> -->
					<!-- <label for="lowRisk"></label><span class="en">Low Risk</span> -->
				  <!-- <br/> -->
				  
				  <!-- <span style="display:inline-block; background-color:#e5e7ea; padding:0px; margin:0px; height:13px; width:13px; overflow:hidden"><input type="checkbox" style="opacity:0.50;padding:0px;margin:0px" name="vio" class="regular-checkbox" value="other" id="other" /></span> -->
					<!-- <label for="other"></label><span class="en">Other</span> -->
				  <!-- <br/>			 -->
		</div>
		<div id="viz"></div>
	</div>
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.4.9/d3.min.js"></script>
<script src="Leaflet.D3SvgOverlay-master/L.D3SvgOverlay.min.js"></script>
<script src="jquery-2.1.1.min.js"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

<script>



	var today = new Date();
	var dd = today.getDate();
	var mm = today.getMonth()+1;
	var yyyy = today.getFullYear();
	today = mm + '/' + dd + '/' + yyyy;	
	d3.select("#today").html(today);
<!-- var grayscale = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/toner-lite/{z}/{x}/{y}.png', {attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'});  -->
<!-- var	streets = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/terrain/{z}/{x}/{y}.png', {attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'});  -->
	
<!-- var map = L.map('map', { -->
	<!-- center: [40.734063, -73.958424], -->
	<!-- zoom: 11, -->
	<!-- layers: [grayscale, streets] -->
<!-- }); -->
<!-- var baseMaps = { -->
	<!-- "Grayscale": grayscale, -->
	<!-- "Streets": streets -->

	
<!-- }; -->
<!-- L.control.layers(baseMaps).addTo(map); -->

var map = L.map('map').setView([40.712824, -74.005999], 11);
L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/toner-lite/{z}/{x}/{y}.png', {attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(map);

var tooltip = d3.select('body').append('div')
	//settings for using hyperlink in tooltip
	.on('mouseover', function(d, i){
		tooltip.transition().duration(0);
	})
	.on('mouseout', function(d, i){
		tooltip.transition().delay(500).style('visibility', 'hidden');
	})
	.attr('class', 'tooltip');
	
var width = $("#map").width(),
	height = $("#map").height();


function init(){
	var rings = [];
	var ringsOverlay = L.d3SvgOverlay(function(sel,proj){
		var ringsUpd = sel.selectAll('circle').data(rings);
		ringsUpd.enter()
			.append('circle')
			.attr('cx',function(d){return proj.latLngToLayerPoint(d.latLng).x;})
			.attr('cy',function(d){return proj.latLngToLayerPoint(d.latLng).y;})
			.attr('class', function(d){
				if (d.Score > 6){
					return "rings";
				}
					return "none";
			})
			
		var highRiskPnts = d3.selectAll(".rings");
		pulsate(highRiskPnts);
		
		function pulsate(highRiskPnts){
			recursive_transitions();
			function recursive_transitions(){
			highRiskPnts.transition()
				<!-- .attr("class", "ring") -->
				<!-- .style("fill", "#BF0000") -->
				<!-- .attr("stroke", "#BF0000") -->
				<!-- .style("opacity", 0.9) -->
				<!-- .style("fill-opacity", 0.35) -->
				.duration(100)
				.attr({
					"class": "ring",
					"fill": "#BF0000",
					"stroke": "#BF0000",
					//"stroke-width": 1.5,
					"r": (1 / proj.scale),
					"opacity": 0.7,
					"fill-opacity": 0.7
				})
				.transition()
				.duration(2000)
				.attr("r", (15 / proj.scale))
				.attr("opacity", 0)
				.each("end", recursive_transitions);
				
				
				
				
				/*
				.duration(100)
				.attr("stroke-width", 1)
				.attr("stroke", "BF0000")
				.attr("r", 1 / proj.scale)
				.ease('sin-in')
				.transition()
				.duration(1000)
				.attr('stroke-width', 1)
				.attr("r", 10 / proj.scale)
				.ease('sine-out')
				.each("end", recursive_transitions);
				*/
			}
		}
	})
	var points = [];
	var pointsOverlay = L.d3SvgOverlay(function(sel,proj){
		
	var pointsUpd = sel.selectAll('circle').data(points);

	pointsUpd.enter()
		.append('circle')
		.attr('cx',function(d){return proj.latLngToLayerPoint(d.latLng).x;})
		.attr('cy',function(d){return proj.latLngToLayerPoint(d.latLng).y;})
		.attr('class', function(d){
			if (d.Score > 6){
				return "high";
			}   
				return "medium";
		})
		
		//.attr('r', 4 / proj.scale)
		.on('click', function(d){
			tooltip.style("visibility", "visible");
			tooltip.html(
				'BIN: ' + d.bin + '</br>' +								
				'ADDRESS: '+ d.Address + ', ' + d.Borough + '</br>' +
				'COMMUNITY DISTRICT: ' + d.CD + '</br>' +
				'RISK SCORE: ' + d.risk + '</br>' +
				'# OF ACTIVE PERMITS: ' + d.NumPermits + '</br>' +
				'# OF STORIES: ' + d.NumStories + '</br>' +
				'JOB TYPE: ' + d.jobType + '</br>' +
				'JOB NUMBER: ' + '<a href= "http://a810-bisweb.nyc.gov/bisweb/JobsQueryByNumberServlet?passjobnumber=' + d.jobNum +'" target=_blank">' + d.jobNum + "</a>" + '</br>' +
				<!-- 'SCAFFOLD/SHED/FENCE: ' + d.Scaffold + '</br>' + -->
				'# OF ACCIDENTS: ' +d.Accidents + '</br>' +
				<!-- 'CO/TCO: ' +d.CO_TCO + '</br>' + -->
				<!-- 'MOST RECENT CO/TCO: ' +d.CO_TCO_Date + '</br>' + -->
				'CONTRACTOR: ' + d.Contractor
			)
			if (d3.event.pageX > (width - 200)) {
			   tooltip.style("left", (d3.event.pageX - 350) + "px");
			} else {
			   tooltip.style("left", (d3.event.pageX + 20) + "px")
					.style("top", (d3.event.pageY -30) + "px");
			}
			if (d3.event.pageY > (height - 150)) {
			   tooltip.style("top", (d3.event.pageY -100) + "px");
			} else {
			   tooltip.style("top", (d3.event.pageY -30) + "px");
			}				
		})
		.on("mouseover", function(d, i){
			tooltip.transition().duration(0); //settings for using hyperlink in tooltip
			$(this).attr("style", "cursor: pointer; fill: #eef442; fill-opacity: 1;");			
		})

		.on("mouseout", function(d, i){			
			$(this).attr("style", "stroke-width: 0px; fill-opacity: .7;");
			return tooltip.transition().delay(500).style("visibility", "hidden"); //settings for using hyperlink in tooltip
		});

		//pointsUpd.attr('r', 3 / proj.scale);
		pointsUpd.attr('r', function(d){
			if (d.Score > 6){
				return (4 / proj.scale);
				//return (1 / proj.scale);
			} 
				return (3 / proj.scale);
		})
		/*
		var highRiskPnts = d3.selectAll(".rings");
		pulsate(highRiskPnts);
		
		function pulsate(highRiskPnts){
			recursive_transitions();
			function recursive_transitions(){
			highRiskPnts.transition()
				<!-- .attr("class", "ring") -->
				<!-- .style("fill", "#BF0000") -->
				<!-- .attr("stroke", "#BF0000") -->
				<!-- .style("opacity", 0.9) -->
				<!-- .style("fill-opacity", 0.35) -->
				
				
				.duration(500)
				.attr("stroke-width", 1.5)
				.attr("r", 1 / proj.scale)
				.ease('sin-in')
				.transition()
				.duration(500)
				.attr('stroke-width', 1.5)
				.attr("r", 8 / proj.scale)
				.ease('sine-out')
				//.style("opacity", 0)
				.each("end", recursive_transitions);
			}
		}	
		*/
	/*
	var viz = d3.select("#viz")
		.append("svg")
		.attr("width", width)
		.attr("height", height)
			.append("g")
			.attr("transform", "translate(" + width / 2 +","+ height / 2 +")")
	
	var speedLineGroup = viz.append("g")
		.attr("class", "speedlines");
	makeRings()
	function makeRings(){
		var highRiskPnts = pointsUpd.selectAll(".high");	
		function myTransition(highRiskPnts){
			var transition = d3.select(this).transition();
			speedLineGroup.append("circle")
				.attr({
					"class": "ring",
					"fill":"red",
					"stroke":"red",
					"cx": highRiskPnts.xcoord,
					"cy": highRiskPnts.ycoord,
					"r":(1 / proj.scale),
					//"opacity": 0.4,
					//"fill-opacity":0.1
				})
				.transition()
				.duration(500)
				.attr("r", 8 / proj.scale)
				.attr("opacity", 0)
				.remove();
			var t = setInterval(function(){
				clearInterval(t);
				myTransition(highRiskPnts)
			},duration);
		}
		highRiskPnts.each(myTransition);
	}
	*/
/*		
		//__vis apped    
		var viz = d3.select("#viz")
			.append("svg")
			.attr("width", width)
			.attr("height", height)
				.append("g")
				.attr("transform", "translate(" + width / 2 + "," + height / 2 + ")")		
			
			
		 //_place holder for rings								
		 var speedLineGroup = viz.append("g")
			 .attr("class", "speedlines");


		function getDurationPerDot(circleData){
			var totalTime = 3000;//3 seconds max
			<!-- var time = totalTime-(circleData.alarmLevel*10) -->
			<!-- return time; -->
		}

		function getOuterRadiusPerDot(circleData){
			var radius = 20;
			<!-- var radius = circleData.alarmLevel*.5; -->
			<!-- return radius; -->
		}

        //invoke rings
        makeRings()
                        
 //window.setInterval(makeRings, 1000);

		function makeRings() {
			var datapoints = d3.selectAll("circle.high");
			var radius = 1;
		  
				function myTransition(circleData){
					
					var transition = d3.select(this).transition();
						
						//var duration = getDurationPerDot(circleData);
						//var outerRadius = getOuterRadiusPerDot(circleData);
						var duration = 3000;
						var outerRadius = 15;

						speedLineGroup.append("circle")
							.attr({
								"class": "ring",
								"fill":"#f25c19",
								"stroke":"#f25c19",
								"stroke-width": 1.5,
								"cx": circleData.xcoord,
								"cy": circleData.ycoord,
								"r":radius,
								"opacity": 0.35,
								"fill-opacity":0.35
							})
							.transition()
							.duration(6000)
							.attr("r", radius + outerRadius )
							.attr("opacity", 0)
							.remove();
				 
					var t= setInterval(function(){
						clearInterval(t);
						myTransition(circleData)
					},700);
					 
					//transition.each('end', myTransition);
				}
	 
		  
		  datapoints.each(myTransition);
		}	
	});
*/


		
});

	

	d3.csv("data/SiteSafetyAutomationOutput.csv",function(data){
				rings = data.map(function(d){
					d.latLng = [+d.Lat,+d.Lon];
					d.risk = [d.Score];
				<!-- var filterData = data.filter(function(d){ -->
					<!-- if (d.Score > 6) { -->
						<!-- return d; -->
					<!-- } -->
				<!-- }) -->
				return d;
				});
				points = data.map(function(d){
				d.latLng = [+d.Lat,+d.Lon];
				d.bin = [d.BIN];				
				d.Address = [d.Address];
				d.Borough = [d.Borough];
				d.CD = (d['Community Board']);
				d.NumPermits = (d['Number of Permits']);
				d.NumStories = (d['Number of Stories']);
				d.jobType = (d['Job Type']);
				d.jobNum = (d['Job Number']);
				<!-- d.Scaffold = [d.ScaffoldShedFence]; -->
				d.Accidents = [d.Accidents];
				<!-- d.CO_TCO = (d['CO/TCO']); -->
				<!-- d.CO_TCO_Date = (d['CO/TCO Recent Date']); -->
				d.risk = [d.Score];
				d.Contractor = [d.Contractor];
			return d;
			});
		ringsOverlay.addTo(map);
		pointsOverlay.addTo(map);
		d3.selectAll(".medium").style("display", "none");
		d3.selectAll(".low").style("display", "none");
	});
}

var highCheckbox = document.querySelector('input[id="highRisk"]');
	medCheckbox = document.querySelector('input[id="medRisk"]');
	//lowCheckbox = document.querySelector('input[id="lowRisk"]');



highCheckbox.onchange = function(){
		if(this.checked){
			d3.selectAll(".high").filter(function(d) {
				return d.Score > 6;
			})
			.style("display", "block");
			d3.selectAll(".rings").filter(function(d) {
				return d.Score > 6;
			})
			.style("display", "block");

		} else {
			d3.selectAll(".high").filter(function(d) {
				return d.Score > 6;
			})
			.style("display", "none");
			d3.selectAll(".rings").filter(function(d) {
				return d.Score > 6;
			})
			.style("display", "none");			
		}
};	
medCheckbox.onchange = function(){
		if(this.checked){
			d3.selectAll(".medium").filter(function(d) {
				return d.Score > 4 && d.Score < 7;
			})
			.style("display", "block");	

		} else {
			d3.selectAll(".medium").filter(function(d) {
				return d.Score > 4 && d.Score < 7;
			})
			.style("display", "none");
						
		}
};
<!-- lowCheckbox.onchange = function(){ -->
		<!-- if(this.checked){ -->
			<!-- d3.selectAll(".low").filter(function(d) { -->
				<!-- return d.Score < 5; -->
			<!-- }) -->
			<!-- .style("display", "block");	 -->

		<!-- } else { -->
			<!-- d3.selectAll(".low").filter(function(d) { -->
				<!-- return d.Score < 5; -->
			<!-- }) -->
			<!-- .style("display", "none"); -->
						
		<!-- } -->
<!-- }; -->

init();

</script>
    
</body>
</html>
